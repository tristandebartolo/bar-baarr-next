// components/DrupalEntities.tsx
"use client";
// Lib
import { useEffect, useRef } from "react";
// Helpers
import { baseRs } from "@/lib/helpers";

import { getDataEmbed } from "@/lib/action/MediaAction";
// Componant
export default function DrupalEntities({
  children,
  langcode,
}: {
  children: React.ReactNode;
  langcode: string;
}) {
  const containerRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    if (!containerRef.current) return;

    const elements = containerRef.current.querySelectorAll(
      "drupal-paragraph, drupal-media",
    );

    if (elements.length === 0) return;

    const loadEntity = async (el: Element) => {
      const tagName = el.tagName.toLowerCase();
      const uuid = el.getAttribute("data-paragraph-id");
      const revisionId =
        el.getAttribute("data-paragraph-revision-id") ||
        el.getAttribute("data-media-revision-id");

      if (!uuid) return;

      try {
        // Détermine le type d’API selon le tag
        const type = tagName === "drupal-paragraph" ? "paragraph" : "media";

        const res = await getDataEmbed(type, uuid, langcode);

        if (!res.success) throw new Error("Not found");
        console.log("res", res);

        const rendered = null;

        if (!rendered) throw new Error("No rendered content");

        // // Remplace la balise par le vrai HTML
        // const temp = document.createElement("div");
        // temp.innerHTML = rendered.trim();

        // // Garde les attributs utiles (align, etc.)
        // const firstChild = temp.firstElementChild;
        // if (firstChild) {
        //   // Copie les data-align, class, etc.
        //   Array.from(el.attributes).forEach((attr) => {
        //     if (attr.name.startsWith("data-") || attr.name === "class") {
        //       firstChild.setAttribute(attr.name, attr.value);
        //     }
        //   });
        //   el.parentNode?.replaceChild(firstChild, el);
        // }
      } catch (err) {
        // console.error(`Failed to load ${tagName} ${uuid}`, err);
        el.innerHTML = `<p class="text-red-600">Contenu indisponible</p>`;
      }
    };

    Promise.all(Array.from(elements).map(loadEntity));
  }, [children]);

  return <div ref={containerRef}>{children}</div>;
}
